<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Qu·∫£n l√Ω ƒëo·∫°n vƒÉn</title>
  <style>
    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 800px;
      color: #222;
      background: #f5f5f5;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    input, button, select {
      font-size: 16px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input { flex: 1 1 200px; }
    button { cursor: pointer; background: #f0f0f0; }

    /* Forms & paragraphs */
    .input-form, .paragraph {
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
    }
    .title-input { width: 100%; margin-bottom: 10px; font-size: 16px; padding: 6px; }
    .content-editor {
      width: 100%; min-height: 100px; padding: 8px;
      border: 1px solid #ccc; border-radius: 3px;
      margin-bottom: 10px; overflow-y: auto;
    }
    .content-editor:empty:before { content: attr(placeholder); color: #aaa; }

    /* Paragraph display */
    .paragraph-id { font-size: 14px; color: #666; margin-bottom: 5px; }
    .paragraph-title {
      font-weight: bold; margin-bottom: 8px;
      background-color: rgba(0,255,255,0.1);
      display: inline-block; padding: 2px 4px; border-radius: 3px;
    }
    .paragraph-content {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .paragraph-content.expanded { display: block; }
    .toggle-btn {
      display: inline-block; margin-top: 6px;
      font-size: 14px; color: #007bff; cursor: pointer;
    }
    .edit-btn, .delete-btn {
      background: none; border: none;
      cursor: pointer; font-size: 18px;
      margin-left: 10px;
    }
    .timestamp { font-size: 12px; color: #999; margin-top: 6px; }

    /* Highlight styles */
    .pre-highlight { background-color: rgba(255,0,0,0.1); font-style: italic; }
    mark { background-color: yellow; }
    .custom-highlight { background-color: rgba(255,0,0,0.2); font-style: italic; font-weight: bold; }
    .highlight-list { margin-top: 10px; }
    .highlight-label { font-size: 18px; color: #F4A460; margin-right: 8px; }
    .highlight-item {
      margin-right: 8px; cursor: pointer;
      text-decoration: underline;
      font-size: 17px; color: #AEEEEE;
    }

    /* Selection toolbar */
    #selectionToolbar {
      position: absolute; display: none;
      background: #fff; border: 1px solid #ccc;
      border-radius: 4px; padding: 4px; z-index: 1000;
    }
    #selectionToolbar button { margin: 0 2px; }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      body { background: #121212; color: #e0e0e0; }
      input, button, select { background: #1e1e1e; color: #e0e0e0; border-color: #333; }
      .input-form, .paragraph { background: #1e1e1e; border-color: #333; }
      .content-editor { background: #1e1e1e; color: #e0e0e0; border-color: #333; }
      .toggle-btn { color: #81a1c1; }
      .paragraph-title { background-color: rgba(0,255,255,0.15); }
      .pre-highlight { background-color: rgba(255,77,77,0.15); }
      mark { background-color: #ffeb3b; color: #000; }
      .custom-highlight { background-color: rgba(255,77,77,0.15); }
      .highlight-label { color: #F4A460; }
      .highlight-item { color: #AEEEEE; }
      .timestamp { color: #bbb; }
      #selectionToolbar { background: #1e1e1e; border-color: #333; }
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="searchInput" placeholder="Nh·∫≠p t·ª´ t√¨m ki·∫øm...">
    <select id="searchMode">
      <option value="content">T√¨m ki·∫øm n·ªôi dung</option>
      <option value="title">T√¨m ki·∫øm ti√™u ƒë·ªÅ</option>
    </select>
    <button id="addBtn">‚ûï Th√™m vƒÉn b·∫£n</button>
    <button id="toggleAllBtn">Xem to√†n b·ªô</button>
  </div>
  <div id="inputArea"></div>
  <div id="paragraphs"></div>
  <div id="selectionToolbar">
    <button id="selHighlightBtn">Highlight</button>
    <button id="selUnhighlightBtn">Unhighlight</button>
  </div>

  <script>
  (function() {
    // Helper to create elements
    const create = (tag, className, text) => {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text) el.textContent = text;
      return el;
    };

    class StorageManager {
      save(pars, id) {
        localStorage.setItem('paragraphs', JSON.stringify(pars));
        localStorage.setItem('lastId', id);
      }
      load() {
        const data = JSON.parse(localStorage.getItem('paragraphs')) || [];
        let lastId = parseInt(localStorage.getItem('lastId'),10) || 0;
        lastId = Math.max(lastId, ...data.map(p => p.id));
        const now = Date.now();
        const valid = data.filter(p => p.expireAt > now).map(p => ({ ...p, highlights: p.highlights||[] }));
        return { paragraphs: valid, lastId };
      }
    }

    class ParagraphManager {
      constructor() {
        const sm = new StorageManager();
        const d = sm.load();
        this.paragraphs = d.paragraphs;
        this.lastId = d.lastId;
        this.storage = sm;
      }
      add(title, content) {
        const now = Date.now();
        const exp = new Date(now);
        exp.setFullYear(exp.getFullYear() + (this.paragraphs.length?5:10));
        this.paragraphs.push({
          id: ++this.lastId,
          title, content,
          createdAt: now,
          expireAt: exp.getTime(),
          highlights: []
        });
        this.save();
      }
      update(id, title, content) {
        const p = this.paragraphs.find(x => x.id===id);
        if (p) Object.assign(p, { title, content });
        this.save();
      }
      delete(id) {
        this.paragraphs = this.paragraphs.filter(x=>x.id!==id)
          .map((x,i)=>({ ...x, id: i+1 }));
        this.lastId = this.paragraphs.length;
        this.save();
      }
      highlight(id, word) {
        const p = this.paragraphs.find(x=>x.id===id);
        if (p && !p.highlights.includes(word)) p.highlights.push(word);
        this.save();
      }
      unhighlight(id, word) {
        const p = this.paragraphs.find(x=>x.id===id);
        if (p) p.highlights = p.highlights.filter(w=>w!==word);
        this.save();
      }
      save() {
        this.storage.save(this.paragraphs, this.lastId);
      }
      getAll() {
        return this.paragraphs
          .filter(p => p.expireAt > Date.now())
          .sort((a,b)=>a.id-b.id);
      }
    }

    class UI {
      constructor() {
        this.pm = new ParagraphManager();
        this.searchMode = 'content';
        this.expanded = new Set();
        this.selRange = null;
        this.init();
      }
      init() {
        this.bindDOM();
        this.bindEvents();
        this.render();
      }
      bindDOM() {
        this.searchInput = document.getElementById('searchInput');
        this.searchModeSel = document.getElementById('searchMode');
        this.addBtn = document.getElementById('addBtn');
        this.toggleAllBtn = document.getElementById('toggleAllBtn');
        this.inputArea = document.getElementById('inputArea');
        this.parsContainer = document.getElementById('paragraphs');
        this.toolbar = document.getElementById('selectionToolbar');
        this.btnH = document.getElementById('selHighlightBtn');
        this.btnU = document.getElementById('selUnhighlightBtn');
      }
      bindEvents() {
        this.searchModeSel.onchange = () => this.render();
        this.searchInput.oninput = () => this.render();
        this.addBtn.onclick = () => this.showForm();
        this.toggleAllBtn.onclick = () => this.toggleAll();
        this.parsContainer.onmouseup = e => this.checkSelection(e);
        this.btnH.onclick = () => this.applyHighlight();
        this.btnU.onclick = () => this.applyUnhighlight();
        document.onmousedown = e => {
          if (!this.toolbar.contains(e.target)) this.hideToolbar();
        };
      }
      showForm(existing) {
        this.inputArea.innerHTML = '';
        const form = create('div','input-form');
        const ti = create('input','title-input'); ti.placeholder='Ti√™u ƒë·ªÅ ƒëo·∫°n vƒÉn';
        const cd = create('div','content-editor'); cd.contentEditable='true'; cd.setAttribute('placeholder','Nh·∫≠p n·ªôi dung...');
        const btn = create('button',null, existing?'üíæ L∆∞u thay ƒë·ªïi':'üíæ L∆∞u ƒëo·∫°n vƒÉn');
        btn.onclick = () => {
          const t=ti.value.trim(), c=cd.innerHTML.trim();
          if (!t||!c) return alert('Vui l√≤ng nh·∫≠p c·∫£ ti√™u ƒë·ªÅ v√† n·ªôi dung!');
          if (existing) this.pm.update(existing.id,t,c);
          else this.pm.add(t,c);
          this.render();
          this.inputArea.innerHTML = '';
        };
        if (existing) { ti.value=existing.title; cd.innerHTML=existing.content; }
        form.append(ti,cd,btn);
        this.inputArea.append(form);
        cd.focus();
      }
      render() {
        this.parsContainer.innerHTML = '';
        const term = this.searchInput.value.trim();
        const mode = this.searchModeSel.value;
        const regex = term?new RegExp(term.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&'),'gi'):null;
        this.pm.getAll().forEach(p => {
          if (regex && !(mode==='content'?regex.test(p.content.replace(/<[^>]+>/g,'')):regex.test(p.title))) return;
          this.parsContainer.append(this.makeParagraph(p,regex,mode));
        });
      }
      makeParagraph(p,regex,mode) {
        const div = create('div','paragraph');
        div.append(create('div','paragraph-id',`ƒêo·∫°n ${p.id}`));
        // Title
        const td = create('div','paragraph-title');
        td.textContent = p.title;
        if (regex && mode==='title') HighlightManager.highlightElement(td,regex);
        div.append(td);
        // Content
        const cd = create('div','paragraph-content');
        let temp = document.createElement('div');
        temp.innerHTML = p.content;
        temp.querySelectorAll('b,strong').forEach(el=>{
          const i=create('i','pre-highlight',el.innerHTML);
          el.replaceWith(i);
        });
        if (regex && mode==='content') HighlightManager.highlightElement(temp,regex);
        cd.innerHTML = temp.innerHTML;
        // Toggle
        const tb = create('span','toggle-btn');
        const expanded = this.expanded.has(p.id);
        cd.classList.toggle('expanded',expanded);
        tb.textContent = expanded?'Thu g·ªçn':'Xem th√™m';
        tb.onclick = () => {
          const exp = cd.classList.toggle('expanded');
          tb.textContent = exp?'Thu g·ªçn':'Xem th√™m';
          exp?this.expanded.add(p.id):this.expanded.delete(p.id);
        };
        div.append(cd,tb);
        // Actions
        const eb=create('button','edit-btn','üñâ'); eb.onclick=()=>this.showForm(p);
        const db=create('button','delete-btn','üóëÔ∏è'); db.onclick=()=>{ if(confirm(`X√°c nh·∫≠n x√≥a ƒëo·∫°n ${p.id}?`)){ this.pm.delete(p.id); this.render(); }};
        div.append(eb,db);
        // Timestamp
        const ts=create('div','timestamp',new Date(p.createdAt).toLocaleString('vi-VN'));
        div.append(ts);
        // Highlights list
        const hlDiv=create('div','highlight-list');
        hlDiv.append(create('span','highlight-label','Highlights:'));
        p.highlights.forEach(w=>{
          const it=create('span','highlight-item',w);
          it.onclick=()=>{ this.pm.unhighlight(p.id,w); this.render(); };
          hlDiv.append(it);
        });
        div.append(hlDiv);
        return div;
      }
      toggleAll() {
        const all = this.toggleAllBtn.textContent.includes('Xem');
        this.pm.getAll().forEach(p=> all?this.expanded.add(p.id):this.expanded.delete(p.id));
        this.toggleAllBtn.textContent = all?'Thu g·ªçn to√†n b·ªô':'Xem to√†n b·ªô';
        this.render();
      }
      checkSelection(e) {
        setTimeout(()=>{
          const sel = window.getSelection();
          if (sel.rangeCount && sel.toString().trim()) {
            const r=sel.getRangeAt(0), rect=r.getBoundingClientRect();
            this.selRange=r;
            this.toolbar.style.top = (rect.top+window.scrollY-40)+'px';
            this.toolbar.style.left = (rect.left+window.scrollX)+'px';
            this.toolbar.style.display='block';
          } else this.hideToolbar();
        },0);
      }
      hideToolbar() { this.toolbar.style.display='none'; this.selRange=null; }
      applyHighlight() {
        if (!this.selRange) return;
        const txt=this.selRange.toString().trim(); if(!txt) return;
        const span=create('span','custom-highlight',txt);
        this.selRange.deleteContents(); this.selRange.insertNode(span);
        const pid=parseInt(span.closest('.paragraph').querySelector('.paragraph-id').textContent.replace('ƒêo·∫°n ',''),10);
        const cont=span.closest('.paragraph').querySelector('.paragraph-content').innerHTML;
        this.pm.update(pid,this.pm.paragraphs.find(p=>p.id===pid).title,cont);
        this.pm.highlight(pid,txt);
        this.hideToolbar(); this.render();
      }
      applyUnhighlight() {
        if (!this.selRange) return;
        const txt=this.selRange.toString().trim(); if(!txt) return;
        const para=this.selRange.startContainer.parentElement.closest('.paragraph');
        if(para){
          para.querySelectorAll('.custom-highlight').forEach(el=>{ if(el.textContent===txt) el.replaceWith(document.createTextNode(txt)); });
          const pid=parseInt(para.querySelector('.paragraph-id').textContent.replace('ƒêo·∫°n ',''),10);
          const cont=para.querySelector('.paragraph-content').innerHTML;
          this.pm.update(pid,this.pm.paragraphs.find(p=>p.id===pid).title,cont);
          this.pm.unhighlight(pid,txt);
        }
        this.hideToolbar(); this.render();
      }
    }

    document.addEventListener('DOMContentLoaded', () => new UI());
  })();
  </script>
</body>
</html>
