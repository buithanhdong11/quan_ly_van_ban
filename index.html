<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Qu·∫£n l√Ω ƒëo·∫°n vƒÉn</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 800px;
      color: #222;
      background: #fff;
    }
    #controls {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      font-size: 16px; padding: 8px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    input { flex: 1 1 200px; }
    button { cursor: pointer; background: #f0f0f0; }

    .input-form, .paragraph {
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 15px;
    }
    .title-input { 
      width:100%; margin-bottom:10px; 
      font-size: 16px; padding: 6px;
    }
    .content-editor {
      width:100%; min-height:100px;
      padding:8px; border:1px solid #ccc; border-radius:3px;
      margin-bottom:10px; overflow-y:auto;
    }
    .content-editor:empty:before {
      content: attr(placeholder); color: #aaa;
    }

    .paragraph-id { font-size:14px; color:#666; margin-bottom:5px; }

    /* ===== Highlight ti√™u ƒë·ªÅ ===== */
    .paragraph-title {
      font-weight:bold;
      margin-bottom:8px;
      background-color: rgba(0, 255, 255, 0.1);
      display: inline-block;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .paragraph-content {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .paragraph-content.expanded { display: block; }

    .toggle-btn {
      display:inline-block; margin-top:6px;
      font-size:14px; color:#007bff; cursor:pointer;
    }

    .paragraph .edit-btn,
    .paragraph .delete-btn {
      background: none; border: none; cursor: pointer;
      font-size: 18px; margin-left: 10px;
      vertical-align: middle;
    }

    /* Pre‚Äëhighlight: in nghi√™ng + n·ªÅn ƒë·ªè nh·∫°t */
    .pre-highlight {
      background-color: rgba(255, 0, 0, 0.1);
      color: inherit;
      font-style: italic;
    }

    /* Search‚Äëhighlight (v√†ng) */
    mark {
      background-color: yellow;
      color: inherit;
    }

    /* Timestamp */
    .timestamp {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
    }

    /* Dark Mode */
    @media (prefers-color-scheme: dark) {
      body {
        background: #121212; color: #e0e0e0;
      }
      input, button {
        background: #1e1e1e; color: #e0e0e0;
        border-color: #333;
      }
      .input-form, .paragraph {
        background: #1e1e1e; border-color: #333;
      }
      .content-editor {
        background: #1e1e1e; color: #e0e0e0;
        border-color: #333;
      }
      .toggle-btn { color: #81a1c1; }
      .paragraph-title {
        background-color: rgba(0, 255, 255, 0.15);
      }
      .pre-highlight {
        background-color: rgba(255, 77, 77, 0.15);
        color: #fff;
        font-style: italic;
      }
      mark {
        background-color: #ffeb3b;
        color: #000;
      }
      .timestamp {
        color: #bbb;
      }
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t·ª´...">
    <button id="addBtn">‚ûï Th√™m vƒÉn b·∫£n</button>
  </div>
  <div id="inputArea"></div>
  <div id="paragraphs"></div>

  <script>
    let paragraphs = [], lastId = 0;

    document.addEventListener('DOMContentLoaded', () => {
      loadParagraphs();
      document.getElementById('addBtn').addEventListener('click', addInputForm);
      document.getElementById('searchInput')
              .addEventListener('input', e => renderParagraphs(e.target.value.trim()));
    });

    function addInputForm() {
      const form = document.createElement('div');
      form.className = 'input-form';

      const titleInput = document.createElement('input');
      titleInput.className = 'title-input';
      titleInput.placeholder = 'Ti√™u ƒë·ªÅ ƒëo·∫°n vƒÉn';

      const contentDiv = document.createElement('div');
      contentDiv.contentEditable = 'true';
      contentDiv.className = 'content-editor';
      contentDiv.setAttribute('placeholder','Nh·∫≠p n·ªôi dung...');

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'üíæ L∆∞u ƒëo·∫°n vƒÉn';
      saveBtn.addEventListener('click', () => {
        const title = titleInput.value.trim();
        const content = contentDiv.innerHTML.trim();
        if (!title || !content) {
          alert('Vui l√≤ng nh·∫≠p c·∫£ ti√™u ƒë·ªÅ v√† n·ªôi dung!');
          return;
        }
        lastId++;
        const now = Date.now();
        const expireYears = paragraphs.length === 0 ? 10 : 5;
        const exp = new Date(now);
        exp.setFullYear(exp.getFullYear() + expireYears);

        paragraphs.push({
          id: lastId,
          title,
          content,
          createdAt: now,
          expireAt: exp.getTime()
        });
        saveParagraphs();
        renderParagraphs(document.getElementById('searchInput').value.trim());
        form.remove();
      });

      form.append(titleInput, contentDiv, saveBtn);
      document.getElementById('inputArea').appendChild(form);
      contentDiv.focus();
    }

    function saveParagraphs() {
      localStorage.setItem('paragraphs', JSON.stringify(paragraphs));
      localStorage.setItem('lastId', lastId);
    }

    function loadParagraphs() {
      const data = localStorage.getItem('paragraphs');
      if (data) paragraphs = JSON.parse(data);
      const idData = localStorage.getItem('lastId');
      lastId = idData ? parseInt(idData, 10) : paragraphs.reduce((m, p) => Math.max(m, p.id), 0);
      const now = Date.now();
      paragraphs = paragraphs.filter(p => p.expireAt > now);
      saveParagraphs();
      renderParagraphs('');
    }

    function renderParagraphs(searchTerm) {
      const container = document.getElementById('paragraphs');
      container.innerHTML = '';
      const now = Date.now();
      paragraphs = paragraphs.filter(p => p.expireAt > now);
      paragraphs.sort((a, b) => a.id - b.id);

      let list = paragraphs;
      if (searchTerm) {
        const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
        list = paragraphs.filter(p => regex.test(stripHTML(p.content)));
      }

      list.forEach(p => {
        const div = document.createElement('div');
        div.className = 'paragraph';

        const idDiv = document.createElement('div');
        idDiv.className = 'paragraph-id';
        idDiv.textContent = `ƒêo·∫°n ${p.id}`;

        const titleDiv = document.createElement('div');
        titleDiv.className = 'paragraph-title';
        titleDiv.textContent = p.title;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'paragraph-content';
        const temp = document.createElement('div');
        temp.innerHTML = p.content;

        // Chuy·ªÉn <b>, <strong> th√†nh <i class="pre-highlight">
        temp.querySelectorAll('b, strong').forEach(el => {
          const i = document.createElement('i');
          i.className = 'pre-highlight';
          i.innerHTML = el.innerHTML;
          el.replaceWith(i);
        });

        // N·∫øu c√≥ searchTerm, highlight v√†ng
        if (searchTerm) {
          const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
          highlightElement(temp, regex);
        }

        contentDiv.innerHTML = temp.innerHTML;

        // n√∫t xem th√™m / thu g·ªçn
        const toggleBtn = document.createElement('span');
        toggleBtn.className = 'toggle-btn';
        toggleBtn.textContent = 'Xem th√™m';
        toggleBtn.addEventListener('click', () => {
          contentDiv.classList.toggle('expanded');
          toggleBtn.textContent = contentDiv.classList.contains('expanded') ? 'Thu g·ªçn' : 'Xem th√™m';
        });

        // n√∫t edit
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'üñâ';
        editBtn.addEventListener('click', () => startEdit(p));

        // n√∫t delete
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.addEventListener('click', () => deletePara(p.id));

        // timestamp
        const tsDiv = document.createElement('div');
        tsDiv.className = 'timestamp';
        const dt = new Date(p.createdAt);
        tsDiv.textContent = dt.toLocaleString('vi-VN', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        div.append(idDiv, titleDiv, contentDiv, toggleBtn, editBtn, deleteBtn, tsDiv);
        container.appendChild(div);
      });

      saveParagraphs();
    }

    function startEdit(p) {
      const form = document.createElement('div');
      form.className = 'input-form';

      const titleInput = document.createElement('input');
      titleInput.className = 'title-input';
      titleInput.value = p.title;

      const contentDiv = document.createElement('div');
      contentDiv.contentEditable = 'true';
      contentDiv.className = 'content-editor';
      contentDiv.innerHTML = p.content;

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'üíæ L∆∞u thay ƒë·ªïi';
      saveBtn.addEventListener('click', () => {
        const t = titleInput.value.trim();
        const c = contentDiv.innerHTML.trim();
        if (!t || !c) {
          alert('Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
          return;
        }
        p.title = t;
        p.content = c;
        saveParagraphs();
        renderParagraphs(document.getElementById('searchInput').value.trim());
        form.remove();
      });

      form.append(titleInput, contentDiv, saveBtn);
      const area = document.getElementById('inputArea');
      area.innerHTML = '';
      area.appendChild(form);
      contentDiv.focus();
    }

    function deletePara(id) {
      if (!confirm(`X√°c nh·∫≠n x√≥a ƒëo·∫°n ${id}?`)) return;
      paragraphs = paragraphs.filter(x => x.id !== id);
      paragraphs.forEach((x, i) => x.id = i + 1);
      lastId = paragraphs.length;
      saveParagraphs();
      renderParagraphs(document.getElementById('searchInput').value.trim());
    }

    function stripHTML(html) {
      const d = document.createElement('div');
      d.innerHTML = html;
      return d.textContent || '';
    }

    function highlightElement(el, regex) {
      Array.from(el.childNodes).forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          const txt = node.textContent;
          let match, last = 0;
          const frag = document.createDocumentFragment();
          regex.lastIndex = 0;
          while ((match = regex.exec(txt)) !== null) {
            const idx = match.index;
            if (idx > last) frag.appendChild(document.createTextNode(txt.slice(last, idx)));
            const mark = document.createElement('mark');
            mark.textContent = match[0];
            frag.appendChild(mark);
            last = idx + match[0].length;
          }
          if (last > 0) {
            if (last < txt.length) frag.appendChild(document.createTextNode(txt.slice(last)));
            node.replaceWith(frag);
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          highlightElement(node, regex);
        }
      });
    }

    function escapeRegExp(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
  </script>
</body>
</html>
